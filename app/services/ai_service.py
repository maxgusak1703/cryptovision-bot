import google.generativeai as genai
from app.config import settings

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API
genai.configure(api_key=settings.GEMINI_API_KEY)

async def get_gemini_advice(user_question: str, portfolio_data: str):

    model = genai.GenerativeModel('gemini-2.5-flash')

    system_instruction = (
        "–¢–∏ ‚Äî CryptoVision AI, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∏–π —Ç–∞ –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π –∫—Ä–∏–ø—Ç–æ-–∞–Ω–∞–ª—ñ—Ç–∏–∫. "
        "–¢–≤–æ—è –º–µ—Ç–∞ ‚Äî –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –ª—é–¥—è–º –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —Ä–∏–Ω–æ–∫, –¥–∞—é—á–∏ –≥–ª–∏–±–æ–∫—ñ, –∞–ª–µ –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ—Ä–∞–¥–∏.\n\n"
        "–°–¢–ò–õ–¨ –í–Ü–î–ü–û–í–Ü–î–Ü:\n"
        "1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –∞–∫—Ç–∏–≤—ñ–≤ —Ç–∞ –Ω–∞—Å—Ç—Ä–æ—é (üìà, üìâ, üõ°, üöÄ) —ñ –≤—Å–µ –±—ñ–ª—å—à–µ –Ω—ñ—è–∫–∏—Ö –µ–º–æ—Ü—ñ–π\n"
        "2. –ë—É–¥—å –ø—Ä—è–º–æ–ª—ñ–Ω—ñ–π–Ω–∏–º: —è–∫—â–æ –∞–∫—Ç–∏–≤ —Å—É–º–Ω—ñ–≤–Ω–∏–π ‚Äî —Å–∫–∞–∂–∏ –ø—Ä–æ —Ü–µ.\n"
        "3. –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø: –î–æ—Ç—Ä–∏–º—É–π—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è Telegram:"
            "1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π Markdown."
            "2. –ñ–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç: —Ä–æ–±–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–æ–¥–≤—ñ–π–Ω–∏—Ö –∑—ñ—Ä–æ—á–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **—Ç–µ–∫—Å—Ç**)."
            "3. –ö—É—Ä—Å–∏–≤: –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –æ–¥–Ω–æ–≥–æ –Ω–∏–∂–Ω—å–æ–≥–æ –ø—ñ–¥–∫—Ä–µ—Å–ª—é–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, _—Ç–µ–∫—Å—Ç_)."
            "4. –°–ø–∏—Å–∫–∏: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–≤–∏—á–∞–π–Ω–∏–π –¥–µ—Ñ—ñ—Å (-) –¥–ª—è –º–∞—Ä–∫–æ–≤–∞–Ω–∏—Ö —Å–ø–∏—Å–∫—ñ–≤."
            "5. –£–Ω–∏–∫–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å, –æ—Å–∫—ñ–ª—å–∫–∏ Telegram —ó—Ö –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î."
            '6. –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–∫–ª–∞–¥–Ω–µ –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è —Å–∏–º–≤–æ–ª—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–µ —Å—Ç–∞–≤ "\\" –ø–µ—Ä–µ–¥ –∫—Ä–∞–ø–∫–∞–º–∏ –∞–±–æ –¥–µ—Ñ—ñ—Å–∞–º–∏), –ø–∏—à–∏ —á–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º.\n"'
        "4. –ú–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞."
    )

    full_prompt = f"""
    {system_instruction}

    –ö–û–ù–¢–ï–ö–°–¢ –ü–û–†–¢–§–ï–õ–Ø: {portfolio_data}
    –ó–ê–ü–ò–¢–ê–ù–ù–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê: {user_question}
    
    –î–∞–π —á—ñ—Ç–∫—É, –∫–æ—Ä–∏—Å–Ω—É —Ç–∞ –Ω–µ –¥–æ–≤–≥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–º–∞–∫—Å. 200 —Å–ª—ñ–≤).
    """

    try:
        response = await model.generate_content_async(
            full_prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.3,

            )
        )
        return response.text if response.text else "‚ùå –®–Ü –∑–∞–¥—É–º–∞–≤—Å—è —ñ –Ω–µ –∑–º—ñ–≥ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏."
    except Exception as e:
        return f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏: {str(e)}"